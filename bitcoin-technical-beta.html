<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title>Ledger Wallet 1 : Technical Specification  (BETA)</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Ledger Wallet 1 : Technical Specification  (BETA)</h1>
<span id="author">Ledger Firmware Team</span><br />
<span id="email"><tt>&lt;<a href="mailto:hello@ledger.fr">hello@ledger.fr</a>&gt;</tt></span><br />
<span id="revdate">firmware version lw1-1.0 - work in progress</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_ledger_wallet_1_1_0_ledger_release_work_in_progress">1. Ledger Wallet 1 - 1.0 ("Ledger" release - work in progress)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] New unified multiplatform / multibearer firmware
</p>
</li>
<li>
<p>
[bev] Replace wipe PIN by random seed PIN
</p>
</li>
<li>
<p>
[enh] Rename SET KEYMAP to SET KEYBOARD CONFIGURATION and configure typing parameters
</p>
</li>
<li>
<p>
[sec] Erase the dongle after 30 invalids second factor attempts
</p>
</li>
<li>
<p>
[enh] Alternate coin versions : SET ALTERNATE COIN VERSIONS
</p>
</li>
<li>
<p>
[enh] Alternate second factor updates :  SET USER KEYCARD APDU, SETUP SECURE SCREEN APDU
</p>
</li>
<li>
<p>
[enh] Personal BIP 70 certificates : STORE TRUST ROOT BIP 70, CREATE CERTIFICATE BIP 70, CREATE PAYMENT REQUEST BIP 70, PROCESS CERTIFICATE BIP 70, PARSE PAYMENT REQUEST BIP70, UNTRUSTED HASH TRANSACTION INPUT FINALIZE FULL BIP 70, FACTORY INITIALIZE BIP 70 TRUST ROOT
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_13_ledger_is_coming_release_17th_of_november_2014">2. 1.4.13 ("Ledger is coming" release - 17th of November 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[bev] Modify the keycard second factor to only check the address
</p>
</li>
<li>
<p>
[bev] Enable the keycard second factor with a specific APDU at boot time
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_12_speedy_rabbit_hotfix_1_release_28th_of_october_2014">3. 1.4.12 ("Speedy Rabbit Hotfix 1" release - 28th of October 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[bug] Fix canonical signatures, buggy since 1.4.9, as per <a href="https://github.com/bitcoin/bips/blob/master/bip-0062.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0062.mediawiki</a>
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_11_speedy_rabbit_release_27th_of_october_2014">4. 1.4.11 ("Speedy Rabbit" release - 27th of October 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] Improve SHA 512 and modular multiplication speed
</p>
</li>
<li>
<p>
[enh] Modify SETUP to include a One Time Pad generated by the customer
</p>
</li>
<li>
<p>
[enh] Let Windows users replay a second factor by triggering num lock or scroll lock
</p>
</li>
<li>
<p>
[sec] Verify that the provided SETUP FORWARD ECDH public key belongs to the curve
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_10_battleship_2_release_8th_of_september_2014">5. 1.4.10 ("Battleship 2" release - 8th of September 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[bug] Fix second factor spurious trigger bug added in 1.4.9
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_9_battleship_release_27th_of_august_2014">6. 1.4.9 ("Battleship" release - 27th of August 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] Provide an option to replace the second factor by a key card
</p>
</li>
<li>
<p>
[enh] Add supported and current operation modes in firmware attestation
</p>
</li>
<li>
<p>
[enh] Dump the seed on every other insertion until the PIN is entered
</p>
</li>
<li>
<p>
[enh] Add number of remaining attempts on VERIFY PIN
</p>
</li>
<li>
<p>
[enh] Return Y parity on signature to save key recovery time (as per FSV <a href="https://github.com/antonio-fr/Fast_Sign_Verify">https://github.com/antonio-fr/Fast_Sign_Verify</a> - Antoine Ferron)
</p>
</li>
<li>
<p>
[enh] Make sure that the returned signatures are canonical (as per <a href="https://ripple.com/wiki/Transaction_Malleability">https://ripple.com/wiki/Transaction_Malleability</a>)
</p>
</li>
<li>
<p>
[sec] Only dump the trusted input and developer wrapping keys in SETUP if developer mode is supported
</p>
</li>
<li>
<p>
[tmp] Temporarily disable the COMPOSE M OF N ADDRESS command due to lack of space
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_8_greenaddress_release_05th_of_august_2014">7. 1.4.8 ("Greenaddress" release - 05th of August 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] Allow 64 bytes seed in SETUP (BIP39 compliance)
</p>
</li>
<li>
<p>
[enh] Return the BIP32 chain code along with the public key in GET WALLET PUBLIC KEY
</p>
</li>
<li>
<p>
[enh] Add 0xB11E derivation path allowing a message signature without second factor and without power cycling, scan the low end word of derivation path components only
</p>
</li>
<li>
<p>
[bug] Remove user entropy in SETUP (not used properly and no buffer space left to type it along with a 64 bytes seed)
</p>
</li>
<li>
<p>
[bug] Allow 0 derivations in BIP32 derivation path
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_7_private_release_open_second_factor_23rd_of_july_2014">8. 1.4.7 (private release, open second factor - 23rd of July 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] Add a mode to skip the second factor if consuming from P2SH inputs
</p>
</li>
<li>
<p>
[enh] Allow derivation from an arbitrary BIP 32 path
</p>
</li>
<li>
<p>
[enh] Return Loader ID in firmware information
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_6_maison_du_bitcoin_hackathon_15th_of_june_2014">9. 1.4.6 ("Maison du Bitcoin" hackathon - 15th of June 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] Point Of Sale mode for setup and seed recovery
</p>
</li>
<li>
<p>
[enh] Allow message signature without confirmation for arbitrary BitID chain
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_5_maison_du_bitcoin_meetup_4th_of_june_2014">10. 1.4.5 ("Maison du Bitcoin" meetup - 4th of June 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[bug] Fix keyboard LED detection on OSX (infinite waiting loop)
</p>
</li>
<li>
<p>
[bug] Fix firmware diversification
</p>
</li>
<li>
<p>
[bug] Fix generic HID transport
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_4_maison_du_bitcoin_opening_release_13th_of_may_2014">11. 1.4.4 ("Maison du Bitcoin" opening release - 13th of May 2014)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[bug] Fix BIP32 implementation regarding hardneded / non hardened keys
</p>
</li>
<li>
<p>
[enh] Implement missing 1.4.3 features
</p>
</li>
<li>
<p>
[enh] Type the seed using the second factor
</p>
</li>
<li>
<p>
[enh] Add firmware version in attestation
</p>
</li>
<li>
<p>
[enh] Restrict signature hashtypes on setup
</p>
</li>
<li>
<p>
[enh] Provide forward setup for prepaid dongles scenarios
</p>
</li>
<li>
<p>
[enh] Secure screen mode for Prismicide prototype
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_3_30c3_failed_release_p_20th_of_march_2014_paymium_meetup_release">12. 1.4.3 (30c3 failed release :p - 20th of March 2014 Paymium Meetup release)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] full redesign : HD Wallet (BIP 32), Keyboard confirmation, server and partial transactions APIs
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_2_bitcoin_2013_release">13. 1.4.2 (Bitcoin 2013 release)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] New security rules &amp; operation modes
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_1_private_release">14. 1.4.1 (private release)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
[enh] ECC operations speed-up
</p>
</li>
<li>
<p>
[bug] Private key are now paired to their curve parameters (cheers Jix :p)
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_0_29c3_release">15. 1.4.0 (29c3 release)</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
Initial release
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_about">16. About</h2>
<div class="sectionbody">
<div class="paragraph"><p>Ledger Wallet is a USB smartcard/dongle dedicated to secure bitcoin transactions. It performs all sensitive cryptographic operations related to a bitcoin transaction (key generation &amp; signature) onboard, and helps protect against malware in an untrusted environment by controlling the signed data.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_user_validation_mode">17. User validation mode</h2>
<div class="sectionbody">
<div class="paragraph"><p>Ledger Wallet allows you to validate what you sign - i.e. check that you are paying the right amount to the right destination. The following User validation methods are available</p></div>
<div class="sect2">
<h3 id="_keyboard_user_validation">17.1. Keyboard User validation</h3>
<div class="paragraph"><p>This method is the original scheme introduced in version 1.4.3 - it is the default method available when operating in legacy BTChip mode</p></div>
<div class="paragraph"><p>User validation is performed as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
A specific status is returned to inform the user that a validation is pending
</p>
</li>
<li>
<p>
The user unplugs the dongle
</p>
</li>
<li>
<p>
The user plugs the dongle back into the computer (or a different computer / smartphone, tablet with USB host support, depending on how confident you are about the first computer integrity)
</p>
</li>
<li>
<p>
The dongle "types" (as a keyboard) a summary of the action to be validated and a 4 digits PIN to be entered, which is unique to the transaction
</p>
</li>
<li>
<p>
The user plugs the dongle back into the first computer (or just unplugs / plugs it again)
</p>
</li>
<li>
<p>
The user enters the PIN to confirm user validation
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_security_card_user_validation">17.2. Security Card User validation</h3>
<div class="paragraph"><p>This user validation mode has been introduced in version 1.4.9 and provide an option to validate a transaction destination using a printed card for easier validation.</p></div>
<div class="paragraph"><p>User validation is performed as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
A specific status is returned to inform the user that a validation is pending. This request includes random indexes in the address to match against the printed card
</p>
</li>
<li>
<p>
The user types the result matching the random indexes in the printed card to confirm user validation
</p>
</li>
</ul></div>
<div class="paragraph"><p>This user validation method should be used with caution as a malware would be able to gather information from each unique Security Card after enough transactions are signed. It is recommended to only use it to pair an secure screen as described later or to print a new card after a few (around 10) transactions have been performed.</p></div>
</div>
<div class="sect2">
<h3 id="_secure_screen_user_validation">17.3. Secure Screen User validation</h3>
<div class="paragraph"><p>This user validation mode has been introduced in version LW1-1.0 and provide an option to validate a transaction destination and amount using a paired device with a screen</p></div>
<div class="paragraph"><p>User validation is performed as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
A specific status is returned to inform the user that a validation is pending. This request includes an encrypted summary of the transaction and a nonce. The symmetric encryption keys are shared when the Ledger Wallet and the remote device are paired. A Security Card challenge is requested to pair the remote device
</p>
</li>
<li>
<p>
The user verifies the transaction summary on the remote device
</p>
</li>
<li>
<p>
The remote device generates a signed version of the nonce which is sent to the Ledger Wallet to confirm user validation
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operation_modes">18. Operation modes</h2>
<div class="sectionbody">
<div class="paragraph"><p>Operation modes define which operations are allowed given the security environment the dongle is operating in.</p></div>
<div class="paragraph"><p>Four operation modes are defined :</p></div>
<div class="ulist"><ul>
<li>
<p>
standard-wallet mode, managing an HD Wallet (BIP 32) with multiple accounts, supporting payments to a single address and enforcing user validation of the full transaction (unless the wallet is setup as a second factor for P2SH transactions). This mode is intended for all bitcoin users.
</p>
</li>
<li>
<p>
relaxed-wallet mode, managing an HD Wallet with multiple accounts, supporting arbitrary payments and enforcing user validation of the amount spent. This mode is intended for bitcoin users interested in drafting custom transactions with some level of control.
</p>
</li>
<li>
<p>
server mode, managing an HD Wallet with multiple accounts, supporting arbitrary payments and enforcing pre defined limits on the amount spent. This mode is intended for server operators using one or several Ledger Wallet dongles to secure their hot wallets.
</p>
</li>
<li>
<p>
developer mode, managing BIP 32 or regular private keys and allowing to sign arbitrary data. This mode is intended for bitcoin power users drafting custom transactions and only interested in private keys protection.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The dongle initally operates in standard-wallet mode when received (if this mode is enabled). The last chosen mode is restored when the dongle is powered on.</p></div>
<div class="sect2">
<h3 id="_standard_wallet_mode">18.1. standard-wallet mode</h3>
<div class="paragraph"><p>Only a single point-to-point output (i.e. the standard script or a P2SH script) along with one change address is authorized.</p></div>
<div class="paragraph"><p>All transaction inputs are controlled by the dongle.</p></div>
<div class="paragraph"><p>The change address index is automatically handled by the dongle and increased for each transaction to prevent address reuse. The change address index is shared for all accounts.</p></div>
<div class="paragraph"><p>The standard script is coded as</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OP_DUP OP_HASH160 [pubKeyHash] OP_EQUALVERIFY OP_CHECKSIG</tt></pre>
</div></div>
<div class="paragraph"><p>A P2SH script is coded as</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OP_HASH160 [script hash] OP_EQUAL</tt></pre>
</div></div>
<div class="paragraph"><p>Transaction are controlled by the user validation process. The following data will be prompted to the user :</p></div>
<div class="ulist"><ul>
<li>
<p>
Amount to pay
</p>
</li>
<li>
<p>
Change amount
</p>
</li>
<li>
<p>
Fees
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_relaxed_wallet_mode">18.2. relaxed-wallet mode</h3>
<div class="paragraph"><p>Arbitrary output is authorized</p></div>
<div class="paragraph"><p>Transaction inputs are only controlled if they use a key actually belonging to a wallet account.</p></div>
<div class="paragraph"><p>Transaction are controlled by the user validation process. The following data will be prompted to the user :</p></div>
<div class="ulist"><ul>
<li>
<p>
Amount to pay
</p>
</li>
<li>
<p>
A large warning that relaxed-wallet mode is in use
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_server_mode">18.3. server mode</h3>
<div class="paragraph"><p>Arbitrary output is authorized</p></div>
<div class="paragraph"><p>Transaction inputs are only controlled if they use a key actually belonging to a wallet account.</p></div>
<div class="paragraph"><p>Transactions are controlled given user parameters and automatically signed if accepted.</p></div>
<div class="paragraph"><p>Transactions can be controlled on a combination of the following parameters :</p></div>
<div class="ulist"><ul>
<li>
<p>
A cumulative maximum amount used in transactions
</p>
</li>
<li>
<p>
A maximum number of consecutive transactions before the dongle is removed
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_developer_mode">18.4. developer mode</h3>
<div class="paragraph"><p>Arbitrary data can be signed in this mode</p></div>
<div class="paragraph"><p>Keys used in developer mode cannot be used in a different mode</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lifecycle_management_apdus">19. Lifecycle management APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_setup">19.1. SETUP</h3>
<div class="sect3">
<h4 id="_description">19.1.1. Description</h4>
<div class="paragraph"><p>This command is used to setup the dongle when received, or pre-issuance when using the forward setup mode. It must be executed on a trusted computer as security critical data is exchanged.</p></div>
<div class="paragraph"><p>For a new dongle not used as a backup device, a regular user will create a new random seed for a HD wallet and a PIN.</p></div>
<div class="paragraph"><p>The PIN is used to perform a new payment transaction - it is sent as cleartext to the dongle and is not intended to be used as a malware protection method, only as an anti theft security.
When generating a new seed in regular setup mode, the dongle types it on every other powerup until the PIN is entered, finishing with an <em>X</em> to mark the end of the seed. It is recommended to do this on a different computer / device for maximum security before backing it up.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">When getting the seed backup, the string must begin with "Seed ", end with an X and be exactly 128 hexadecimal digits long (64 bytes). If not, you&#8217;re missing either the beginning or the end of the seed and should retry until you see the whole seed.</td>
</tr></table>
</div>
<div class="paragraph"><p>In Point Of Sale setup mode, a PIN is exchanged between the user and the dongle. The seed is generated but not typed, and can be recovered through GET POINT OF SALE SEED commands. Until the encrypted seed is recovered, GET WALLET PUBLIC KEY is enabled without needing to enter the PIN. This mode is typically used for a service (such as a physical counter) offering prepaid dongles with KYC procedures and wanting to deliver a physical backup of the seed.</p></div>
<div class="paragraph"><p>In forward setup mode, a secret PIN and a secret One Time Pad are exchanged between the user and the dongle. The seed is generated but not typed, and only GET WALLET PUBLIC KEY is enabled, without needing to enter the PIN. It is returned encrypted by the One Time Pad, so that only the user who generated the One Time Pad can decrypt it, and also typed after the first PIN entry. This mode is typically used for a service (such as a web shop or a vending machine) offering prepaid dongles and willing to provide the seed to the end user without compromising the security of the transactions.</p></div>
<div class="paragraph"><p>After SETUP is performed, the dongle has to be reset to wipe out all parameters and start again - this can be achieved by entering the wrong PIN 3 times in a row.</p></div>
<div class="paragraph"><p>A secondary PIN can be provided for plausible deniability - when entered instead of the regular user PIN, a random seed generated during setup is used for this session. This seed should not be used to store any important amount as it is erased when the dongle is reset.</p></div>
<div class="paragraph"><p>It is recommended to store the BIP32 seed returned in the output of the SETUP command in a safe location for backup purposes - typically GPG encrypt it to yourself and store it on multiple storage devices / clouds.</p></div>
<div class="paragraph"><p>During setup, two random BIP 70 3DES-2 encryption and signature keys are generated.</p></div>
<div class="paragraph"><p>The coin regular version and P2SH versions can be changed dynamically during a card session. They are initialized with the versions provided in the setup command at boot time.</p></div>
</div>
<div class="sect3">
<h4 id="_coding">19.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">20</p></td>
<td align="left" valign="top"><p class="table">00 : regular setup</p>
<p class="table">                    02 : Point Of Sale setup</p>
<p class="table">                    80 : forward setup</p></td>
<td align="left" valign="top"><p class="table">00 : when used in forward setup mode, type the seed on the first successful PIN entry</p>
<p class="table">                    01 : when used in forward setup, do not type the seed on the first successful PIN entry</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (regular setup)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of supported operation modes</p>
<p class="table">    0x01 : wallet mode</p>
<p class="table">    0x02 : relaxed wallet mode</p>
<p class="table">    0x04 : server mode</p>
<p class="table">    0x08 : developer mode</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of features</p>
<p class="table">    0x01 : use uncompressed public keys in addresses (otherwise compress them)</p>
<p class="table">    0x02 : enable RFC 6979 deterministic signatures (otherwise use a random K)</p>
<p class="table">    0x04 : authorize all signature hashtypes (otherwise only authorize SIGHASH_ALL)</p>
<p class="table">    0x08 : skip second factor, allow relaxed inputs and arbitrary ouput scripts if consuming P2SH inputs in a transaction</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for regular addresses</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for Pay To Script Hash Addresses (BIP 16), or 0x00 if disabled</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN length (from 0x04 up to 0x20)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN length (from 0x00 up to 0x04)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Seed size (0x00 to generate a new 64 bytes seed, size between 32 and 64 to restore a seed backup)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Seed if restoring a seed backup</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 key wrapping key length for developer mode (0x00 to generate a new key,
  0x10 to set up a backup)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 key wrapping key for developer mode</p></td>
<td align="left" valign="top"><p class="table">null or 16</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (Point Of Sale setup)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of supported operation modes</p>
<p class="table">    0x01 : wallet mode</p>
<p class="table">    0x02 : relaxed wallet mode</p>
<p class="table">    0x04 : server mode</p>
<p class="table">    0x08 : developer mode</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of features</p>
<p class="table">    0x01 : use uncompressed public keys in addresses (otherwise compress them)</p>
<p class="table">    0x02 : enable RFC 6979 deterministic signatures (otherwise use a random K)</p>
<p class="table">    0x04 : authorize all signature hashtypes (otherwise only authorize SIGHASH_ALL)</p>
<p class="table">    0x08 : skip second factor if consuming only P2SH inputs in a transaction</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for regular addresses</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for Pay To Script Hash Addresses (BIP 16), or 0x00 if disabled</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN length (from 0x04 up to 0x20)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN length (from 0x00 up to 0x04)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Seed size (0x00 to generate a new 64 bytes seed, 64 to restore a seed backup)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Seed if restoring a seed backup</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">0x00 or 0x10 if restoring a seed backup</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 seed backup wrapping key wrapping key if restoring a seed backup</p></td>
<td align="left" valign="top"><p class="table">null or 16</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (forward setup)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of supported operation modes</p>
<p class="table">    0x01 : wallet mode</p>
<p class="table">    0x02 : relaxed wallet mode</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitflag of features</p>
<p class="table">    0x01 : use uncompressed public keys in addresses (otherwise compress them)</p>
<p class="table">    0x02 : enable RFC 6979 deterministic signatures (otherwise use a random K)</p>
<p class="table">    0x04 : authorize all signature hashtypes (otherwise only authorize SIGHASH_ALL)</p>
<p class="table">    0x08 : skip second factor if consuming only P2SH inputs in a transaction</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for regular addresses</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for Pay To Script Hash Addresses (BIP 16), or 0x00 if disabled</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User public key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User public key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Password blob</p></td>
<td align="left" valign="top"><p class="table">40</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Seed size (0x00 to generate a new seed)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 key wrapping key length for developer mode (0x00 to generate a new key)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The password blob is generated as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
An ECDH key exchange is performed on the user side using a newly generated keypair on the Bitcoin curve and the dongle Attestation public key - a 32 bytes secret is obtained, split into two 16 bytes components S1 and S2
</p>
</li>
<li>
<p>
S1 and S2 are XORed to produce a 16 bytes 3DES-2 session key
</p>
</li>
<li>
<p>
The following data is encrypted using 3DES CBC and the generated session key, and sent as password blob
</p>
</li>
</ul></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN length (from 0x04 up to 0x20)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User PIN (padded with random)</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN length (from 0x00 up to 0x04)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Secondary PIN (padded with random)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Random data used as a XOR One Time Pad to mask the seed</p></td>
<td align="left" valign="top"><p class="table">64</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CRC-16 of the previous data</p></td>
<td align="left" valign="top"><p class="table">2</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Additional description of setup parameters</em></p></div>
<div class="paragraph"><p>When enabled, RFC 6979 deterministic signatures will be used for all operations in wallet, relaxed wallet and server modes. RFC 6979 deterministic signatures are always available in developer mode.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Using deterministic signatures will make the signing process slower and could possibly create a larger side channel attack surface due to the way private keys are handled during the computation of the random value. We suggest to only enable this mode if you don&#8217;t trust the chip hardware Random Number Generator or are sure of understanding the risks.</td>
</tr></table>
</div>
<div class="paragraph"><p>The following sample Coin versions are defined for regular addresses</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Network</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Version (dec)</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitcoin (main network)</p></td>
<td align="left" valign="top"><p class="table">0</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitcoin (test network)</p></td>
<td align="left" valign="top"><p class="table">111</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Litecoin (main network)</p></td>
<td align="left" valign="top"><p class="table">48</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Litecoin (test network)</p></td>
<td align="left" valign="top"><p class="table">111</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Dogecoin (main network)</p></td>
<td align="left" valign="top"><p class="table">30</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Dogecoin (test network)</p></td>
<td align="left" valign="top"><p class="table">113</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The following sample Coin version are defined for Pay To Script Hash addresses</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Network</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Version (dec)</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitcoin (main network)</p></td>
<td align="left" valign="top"><p class="table">5</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Bitcoin (test network)</p></td>
<td align="left" valign="top"><p class="table">196</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Litecoin (main network)</p></td>
<td align="left" valign="top"><p class="table">5</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Litecoin (test network)</p></td>
<td align="left" valign="top"><p class="table">196</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Dogecoin (main network)</p></td>
<td align="left" valign="top"><p class="table">22</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Dogecoin (test network)</p></td>
<td align="left" valign="top"><p class="table">196</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>If generating a new seed, the dongle generates a 64 bytes random number from its hardware Random Number Generator</p></div>
<div class="paragraph"><p>A keymap encoding is a set of Keyboard HID Usage IDs mapping the keyboard layout of the computer on which the user validation is performed. It can be updated later using the SET KEYBOARD CONFIGURATION command.</p></div>
<div class="paragraph" id="KeymapEncoding"><p>Keymap encoding is coded as follows</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ALT-GR usage keymap</p></td>
<td align="left" valign="top"><p class="table">12</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Shift usage keymap</p></td>
<td align="left" valign="top"><p class="table">12</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">HID page table for ASCII codes from 0x20 to 0x7e</p></td>
<td align="left" valign="top"><p class="table">95</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>ALT-GR &amp; Shift usage keymaps are coded as a set of flags indicating if the ALT-GR / Shift key should be pushed for the given mapping. First byte codes shift flags from keycode 0x20 (LSB) to 0x27 (MSB) and so on.</p></div>
<div class="paragraph"><p>The default QWERTY Keymap Encoding is</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>00 00 00 00 00 00 00 00 00 00 00 00
76 0f 00 d4 ff ff ff c7 00 00 00 78
2c 1e 34 20 21 22 24 34 26 27
25 2e 36 2d 37 38 27 1e 1f 20
21 22 23 24 25 26 33 33 36 2e
37 38 1f 04 05 06 07 08 09 0a
0b 0c 0d 0e 0f 10 11 12 13 14
15 16 17 18 19 1a 1b 1c 1d 2f
31 30 23 2d 35 04 05 06 07 08
09 0a 0b 0c 0d 0e 0f 10 11 12
13 14 15 16 17 18 19 1a 1b 1c
1d 2f 31 30 35</tt></pre>
</div></div>
<div class="paragraph"><p><em>Output data (if developer mode is supported)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Seed return flag</p>
<p class="table">      0x00 : seed is not typed to the user</p>
<p class="table">      0x01 : seed typed to the user</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 trusted input key</p></td>
<td align="left" valign="top"><p class="table">16</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-2 key wrapping key for developer mode</p></td>
<td align="left" valign="top"><p class="table">16</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (if developer mode is not supported)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Seed return flag</p>
<p class="table">      0x00 : seed is not typed to the user</p>
<p class="table">      0x01 : seed typed to the user</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (if using forward setup)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Seed return flag</p>
<p class="table">      0x00 : seed is not typed to the user</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Seed XORed by the provided One Time Pad</p></td>
<td align="left" valign="top"><p class="table">64</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available before the dongle is set up (either when received or following a dongle reset)</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_user_keycard">19.2. SET USER KEYCARD</h3>
<div class="sect3">
<h4 id="_description_2">19.2.1. Description</h4>
<div class="paragraph"><p>This command is used to replace the keyboard second factor by a printed keycard for regular (non relaxed) transactions.</p></div>
<div class="paragraph"><p>The keycard associates each ASCII character between 0x30 and 0x7a (included) to an hexadecimal digit, obtained by encrypting 00..50 by the 3DES-2 keycard seed key using CBC encryption, and considering each digit as an exclusive OR of both nibbles of each element</p></div>
<div class="paragraph"><p>When using the keycard second factor, the user needs to provide as authentication code random A characters of the destination address (up to 10)</p></div>
<div class="paragraph"><p>This command allows the user to set a new keycard, similar to <a href="#Keycard">[Keycard]</a>. This keycard will replace the system keycard if a system keycard was defined, until the dongle is reset.</p></div>
<div class="paragraph"><p>If no previous keycard was set, this command is confirmed by the standard keyboard second factor. After issuing it, the user needs to confirm it using the unique PIN displayed by the second factor. Otherwise it is confirmed by a 4 bytes challenge with the previous keycard. The dongle must be power cycled if the challenge is not correct.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_2">19.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
<td align="left" valign="top"><p class="table">01 : set keycard</p>
<p class="table">02 : confirm keycard</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">11</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (set keycard)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of random address characters A to provide (1 byte) + keycard seed (16 bytes)</p></td>
<td align="left" valign="top"><p class="table">11</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (confirm keycard)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Confirmation PIN or challenge</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (set keycard)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Confirmation mode</p>
<p class="table">         01 : keyboard second factor</p>
<p class="table">         02 : previous keycard challenge</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">If a previous keycard was set, challenge to match</p></td>
<td align="left" valign="top"><p class="table">04</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (confirm keycard)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_setup_secure_screen">19.3. SETUP SECURE SCREEN</h3>
<div class="sect3">
<h4 id="_description_3">19.3.1. Description</h4>
<div class="paragraph"><p>This command is used to replace a printed keycard second factor by a transaction summary displayed on a remote screen. A printed keycard must be set up before issuing this command.</p></div>
<div class="paragraph"><p>The pairing process is performed as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
An ECDH key exchange is performed on the remote screen side side using a newly generated keypair on the Bitcoin curve and the dongle Attestation public key - a 32 bytes secret is obtained, split into two 16 bytes components S1 and S2
</p>
</li>
<li>
<p>
S1 and S2 are XORed to produce a 16 bytes 3DES-2 session key
</p>
</li>
<li>
<p>
The remote screen public key is sent to the dongle, which generates a cleartext random 8 bytes nonce, a 4 bytes challenge on the printed keycard and a random 16 bytes 3DES-2 pairing key, concatenated and encrypted using 3DES CBC and the generated session key
</p>
</li>
<li>
<p>
This message is decrypted on the remote screen side and the user is prompted for the printed card challenge, which is returned concatenated with the nonce, encrypted using 3DES CBC and the generated session key
</p>
</li>
<li>
<p>
The pairing process is completed on the dongle side if the challenge is correct, otherwise the dongle must be power cycled.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_coding_3">19.3.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">12</p></td>
<td align="left" valign="top"><p class="table">01 : initiate pairing</p>
<p class="table">02 : confirm pairing</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (initiate pairing)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Remote screen uncompressed public key</p></td>
<td align="left" valign="top"><p class="table">65</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (confirm pairing)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encrypted nonce and challenge response + padding</p></td>
<td align="left" valign="top"><p class="table">16</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (initiate pairing)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Pairing blob : 8 bytes random nonce and (4 bytes keycard challenge</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">16 bytes pairing key) encrypted by the session key</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (confirm keycard)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_alternate_coin_versions">19.4. SET ALTERNATE COIN VERSIONS</h3>
<div class="sect3">
<h4 id="_description_4">19.4.1. Description</h4>
<div class="paragraph"><p>This command allows you to change the current coin version &amp; P2SH version for the current session, until the dongle is reset.</p></div>
<div class="paragraph"><p>It can be used to support several coin types in the derivation scheme using the same seed</p></div>
</div>
<div class="sect3">
<h4 id="_coding_4">19.4.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">14</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">02</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for regular addresses</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Coin version accepted for Pay To Script Hash Addresses (BIP 16), or 0x00 if disabled</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_pin">19.5. VERIFY PIN</h3>
<div class="sect3">
<h4 id="_description_5">19.5.1. Description</h4>
<div class="paragraph"><p>This command is used to unlock the dongle using the PIN provided during setup.</p></div>
<div class="paragraph"><p>If forward setup mode was used, the seed will be typed to the user on the first PIN entry and signature operations are enabled if a keymap was set. Otherwise the command will be denied.</p></div>
<div class="paragraph"><p>The dongle must be physically reset after each invalid PIN to issue a new command.</p></div>
<div class="paragraph"><p>After 3 invalid PIN submitted in a row, the dongle data is erased and it must be setup again.</p></div>
<div class="paragraph"><p>If the secondary PIN is entered instead of the user PIN, a random seed generated when the dongle is setup is used.</p></div>
<div class="paragraph"><p>If P1 is set to 0x80, the dongle returns the number of remaining attempts. Arbitrary data must still be sent (f.e. 1 byte)</p></div>
</div>
<div class="sect3">
<h4 id="_coding_5">19.5.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">22</p></td>
<td align="left" valign="top"><p class="table">00 : verify PIN</p>
<p class="table">                    80 : get number of remaining attempts</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PIN</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PIN validation flags</p>
<p class="table">      0x01 : dongle was initialized in forward setup mode and needs to be power cycled to read the seed</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup.</p></div>
<div class="paragraph"><p><em>Specific Status Words</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>SW</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">63Cx</p></td>
<td align="left" valign="top"><p class="table">Invalid PIN, x remaining attempts</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_get_operation_mode">19.6. GET OPERATION MODE</h3>
<div class="sect3">
<h4 id="_description_6">19.6.1. Description</h4>
<div class="paragraph"><p>This command returns the current operation mode used by the dongle</p></div>
<div class="paragraph"><p>The forward setup mask is present if a forward setup mode was performed and the seed has not been redeemed by the end user yet.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_6">19.6.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">24</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Operation Mode</p>
<p class="table">      0x01 : standard wallet</p>
<p class="table">      0x02 : relaxed wallet</p>
<p class="table">      0x04 : server</p>
<p class="table">      0x08 : developer</p>
<p class="table">      0x80 : mask added if forward setup mode was used and the seed has not been redeemed yet</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_operation_mode">19.7. SET OPERATION MODE</h3>
<div class="sect3">
<h4 id="_description_7">19.7.1. Description</h4>
<div class="paragraph"><p>This command sets the operation mode that will be used by the dongle after the next power up.</p></div>
<div class="paragraph"><p>The dongle must be physically reset following this command if switching to a different mode than the current mode.</p></div>
<div class="paragraph"><p>If a keycard or a secure screen have been provisioned, they can be enabled with this command. The alternate second factor is only enabled until the dongle is power cycled.</p></div>
<div class="paragraph"><p>If the requested mode has been disabled on setup, an error will be returned.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_7">19.7.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">26</p></td>
<td align="left" valign="top"><p class="table">00 : do not enable the alternate second factor (only valid if switching to standard operation mode)</p>
<p class="table">01 : enable the alternate second factor (only valid if switching to standard operation mode)</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Operation Mode</p>
<p class="table">      0x01 : standard wallet</p>
<p class="table">      0x02 : relaxed wallet</p>
<p class="table">      0x04 : server</p>
<p class="table">      0x08 : developer</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_keyboard_configuration">19.8. SET KEYBOARD CONFIGURATION</h3>
<div class="sect3">
<h4 id="_description_8">19.8.1. Description</h4>
<div class="paragraph"><p>This command sets or modifies the keymap and typing behaviour following dongle setup.</p></div>
<div class="paragraph"><p>The keymap is encoded as in <a href="#KeymapEncoding">[KeymapEncoding]</a></p></div>
</div>
<div class="sect3">
<h4 id="_coding_8">19.8.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">28</p></td>
<td align="left" valign="top"><p class="table">00 : set keymap</p>
<p class="table">01 : set typing behaviour</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (set keymap)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ALT-GR usage keymap</p></td>
<td align="left" valign="top"><p class="table">12</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Shift usage keymap</p></td>
<td align="left" valign="top"><p class="table">12</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">HID page table for ASCII codes from 0x20 to 0x7e</p></td>
<td align="left" valign="top"><p class="table">95</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (set typing behaviour)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Unit delay before starting to type (in CPU cycles, big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of unit delay to wait before starting to type (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Unit delay between each key (in CPU cycles, big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of unit delay to wait between each key (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup, and is protected by the user PIN if not operating in forward setup mode.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wallet_usage_apdus">20. Wallet usage APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_get_wallet_public_key">20.1. GET WALLET PUBLIC KEY</h3>
<div class="sect3">
<h4 id="_description_9">20.1.1. Description</h4>
<div class="paragraph"><p>This command returns the public key and Base58 encoded address for the given BIP 32 path.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_9">20.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">40</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public Key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Uncompressed Public Key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Base58 bitcoin address length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Base58 encoded bitcoin address</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP32 Chain code</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_trusted_input">20.2. GET TRUSTED INPUT</h3>
<div class="sect3">
<h4 id="_description_10">20.2.1. Description</h4>
<div class="paragraph"><p>This command is used to extract a Trusted Input (encrypted transaction hash, output index, output amount) from a transaction.</p></div>
<div class="paragraph"><p>The transaction data to be provided should be encoded using bitcoin standard raw transaction encoding. Scripts can be sent over several APDUs. Other individual transaction elements split over different APDUs will be rejected. 64 bits varints are rejected.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_10">20.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">42</p></td>
<td align="left" valign="top"><p class="table">00 : first transaction data block</p>
<p class="table">                    80 : subsequent transaction data block</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (first block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Input index to lookup (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (next block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (non last block)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (last block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trusted Input</p></td>
<td align="left" valign="top"><p class="table">56</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_untrusted_hash_transaction_input_start">20.3. UNTRUSTED HASH TRANSACTION INPUT START</h3>
<div class="sect3">
<h4 id="_description_11">20.3.1. Description</h4>
<div class="paragraph"><p>This command is used to compose an opaque SHA-256 hash for a new transaction.</p></div>
<div class="paragraph"><p>This transaction can be verified by the user and using transaction rules according to the current dongle operation mode.</p></div>
<div class="paragraph"><p>If a new transaction is started, a VERIFY PIN command shall have been issued previously to unlock the dongle at least once following the dongle power up</p></div>
<div class="paragraph"><p>The transaction data to be provided should be encoded using bitcoin standard raw transaction encoded as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
A 1 byte flag is added before each input in the transaction - if the input is passed as a Trusted Input, this flag is set to 0x01 - otherwise, it is set to 0x00. Non Trusted Inputs can be used in relaxed mode for inputs that are not signed, or for all P2SH inputs when the dongle has been setup to skip the second factor when dealing with P2SH inputs.
</p>
</li>
<li>
<p>
When using a Trusted Input, each input outpoint is replaced by the Trusted Input length (1 byte) and the Trusted Input data
</p>
</li>
<li>
<p>
The input scripts shall be prepared by the host for the transaction signing process as per bitcoin rules : the current input script being signed shall be the previous output script (or the redeeming script when consuming a P2SH output), and other input script shall be null.
</p>
</li>
<li>
<p>
The encoded transaction data shall be provided up to (and not including) the number of outputs.
</p>
</li>
<li>
<p>
Scripts can be sent over several APDUs. Other individual transaction elements split over different APDUs will be rejected. 64 bits varints are rejected.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_coding_11">20.3.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">44</p></td>
<td align="left" valign="top"><p class="table">00 : first transaction data block</p>
<p class="table">                    80 : subsequent transaction data block</p></td>
<td align="left" valign="top"><p class="table">00 : start signing a new transaction</p>
<p class="table">                         80 : continue signing another input of the current transaction</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes, and is protected by the user PIN when starting to sign a new transaction (P1 and P2 set to 0x00)</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_untrusted_hash_transaction_input_finalize">20.4. UNTRUSTED HASH TRANSACTION INPUT FINALIZE</h3>
<div class="sect3">
<h4 id="_description_12">20.4.1. Description</h4>
<div class="paragraph"><p>This command is used to compose an opaque SHA-256 hash for the transaction outputs</p></div>
<div class="paragraph"><p>This command is rejected if all inputs advertised at the beginning of the transaction have not been processed first.</p></div>
<div class="paragraph"><p>The generated script will be the standard script coded as below given the address for a non script address</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OP_DUP OP_HASH160 [pubKeyHash] OP_EQUALVERIFY OP_CHECKSIG</tt></pre>
</div></div>
<div class="paragraph"><p>For a P2SH script address the generated script will be</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>OP_HASH160 [script hash] OP_EQUAL</tt></pre>
</div></div>
<div class="paragraph"><p>The output amount, fees and change will be validated by the user in wallet or relaxed wallet modes.</p></div>
<div class="paragraph"><p>The generated transaction output data contains in pre-serialized form the number of outputs (target &amp; optionally change) and each output data</p></div>
<div class="paragraph"><p>If a keycard seed has been provided, and the wallet is operating in standard mode with the alternate second factor activated, an alternate second factor validation scheme is used, see <a href="#Keycard">[Keycard]</a></p></div>
<div class="paragraph"><p>After 30 invalid second factor challenges submitted in a row, the dongle data is erased and it must be setup again.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_12">20.4.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">46</p></td>
<td align="left" valign="top"><p class="table">01 : output address provided as version byte + binary hash160</p>
<p class="table">                    02 : output address provided as base58 string</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of the Output Address</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output Address (base58 or hash160)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Amount (big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Fees (big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index for the internal change address (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index for the internal change address (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (if no keycard seed is set)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction user validation flag</p>
<p class="table">      0x00 : no user validation requested</p>
<p class="table">      0x01 : user validation requested</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (if keycard seed is set and no secure screen is paired)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction user validation flag</p>
<p class="table">      0x02 : user validation requested with keycard</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Indexes of variable positions in the address to check</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (if keycard seed is set and a secure screen is paired)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Generated transaction output data</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction user validation flag</p>
<p class="table">      0x03 : user validation requested with secure screen or keycard</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of variable positions in the address to check</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Indexes of variable positions in the address to check</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Second factor data 3DES-CBC encrypted by the pairing key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The second factor data is coded as follows</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Unique PIN</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output amount (satoshis, big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Fees (satoshis, big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Change (satoshis, big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output address length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output address</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_untrusted_hash_sign">20.5. UNTRUSTED HASH SIGN</h3>
<div class="sect3">
<h4 id="_description_13">20.5.1. Description</h4>
<div class="paragraph"><p>This command is used to sign a given secure hash using a private key (after re-hashing it following the standard Bitcoin signing process) to finalize a transaction input signing process.</p></div>
<div class="paragraph"><p>This command will be rejected if the transaction signing state is not consistent or if a user validation is required and the provided user validation code is not correct.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_13">20.5.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">48</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index for the private key to use (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index for the private key to use (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code length (or 0x00)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Lock Time (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SigHashType</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signed hash, as ASN-1 encoded R &amp; S components. Mask first byte with 0xFE</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">SigHashType</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_untrusted_hash_transaction_input_finalize_full">20.6. UNTRUSTED HASH TRANSACTION INPUT FINALIZE FULL</h3>
<div class="sect3">
<h4 id="_description_14">20.6.1. Description</h4>
<div class="paragraph"><p>This command is used to compose an opaque SHA-256 hash for the transaction outputs</p></div>
<div class="paragraph"><p>This command is rejected if all inputs advertised at the beginning of the transaction have not been processed first.</p></div>
<div class="paragraph"><p>Output data can be split arbitrarily.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_14">20.6.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">4A</p></td>
<td align="left" valign="top"><p class="table">00 : more input data to be sent</p>
<p class="table">                    80 : last input data block to be sent</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (first block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Start of output data, containing the number of outputs encoded as a Bitcoin varint</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (optional next blocks)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output data continued</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (not last block)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (last block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction user validation flag</p>
<p class="table">      0x00 : no user validation requested</p>
<p class="table">      0x01 : user validation requested</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is available following dongle setup in standard wallet mode when the dongle has been setup to skip the second factor when dealing with P2SH inputs and the current transaction is consuming P2SH inputs, or always available following dongle setup in relaxed wallet and server operation modes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_sign_message">20.7. SIGN MESSAGE</h3>
<div class="sect3">
<h4 id="_description_15">20.7.1. Description</h4>
<div class="paragraph"><p>This command is used to sign a maximum 140 bytes long text message using a private key. The message must be ASCII printable (each byte of the message must be between 0x20 and 0x7e, both included)</p></div>
<div class="paragraph"><p>The message is provided to the dongle, which types it along with a single usage transaction PIN when it&#8217;s power cycled.</p></div>
<div class="paragraph"><p>The transaction PIN is then sent back to this command to retrieve the message signature</p></div>
<div class="paragraph"><p>The signature is performed as follows :</p></div>
<div class="ulist"><ul>
<li>
<p>
The data to sign is the magic "\x18Bitcoin Signed Message:\n" - followed by the length of the message to sign on 1 byte (if requested) followed by the binary content of the message
</p>
</li>
<li>
<p>
The signature is performed on a double SHA-256 hash of the data to sign using the selected private key
</p>
</li>
</ul></div>
<div class="paragraph"><p>The signature is returned using the standard ASN-1 encoding. To convert it to the proprietary Bitcoin-QT format, the host has to :</p></div>
<div class="ulist"><ul>
<li>
<p>
Get the parity of the first byte (sequence) : P
</p>
</li>
<li>
<p>
Add 27 to P if the public key is not compressed, otherwise add 31 to P
</p>
</li>
<li>
<p>
Return the Base64 encoded version of P || r || s
</p>
</li>
</ul></div>
<div class="paragraph"><p>If the low end word of one component of the BIP 32 derivation path includes 0xB11D or 0xB11E the message is immediately signed without confirmation (typically used for BitID). The dongle must be powercycled after signing with a derivation path containing 0xB11D.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_15">20.7.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">4E</p></td>
<td align="left" valign="top"><p class="table">00 : prepare message</p>
<p class="table">                    80 : sign message</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data in prepare mode</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index of the private key to use (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index of the private key to use (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Message length (max 140)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Message</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data in sign mode</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code length (or 00 in server mode)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data in prepare mode</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Transaction user validation flag</p>
<p class="table">      0x00 : no user validation requested</p>
<p class="table">      0x01 : user validation requested</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data in sign mode</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">ASN-1 encoded message signature with Y parity indicated in the first (sequence) byte</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and server operation modes and is protected by the user PIN when preparing a message to sign (P1 set to 0x00)</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_personal_bip_70_certificates_apdus">21. Personal BIP 70 Certificates APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_store_trust_root_bip_70">21.1. STORE TRUST ROOT BIP 70</h3>
<div class="sect3">
<h4 id="_description_16">21.1.1. Description</h4>
<div class="paragraph"><p>This command is used to store a user controlled trust root private key in a slot (3 slots are defined). It must be executed in a secure environment.</p></div>
<div class="paragraph"><p>A keyboard second factor validation is required to proceed.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_16">21.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">30</p></td>
<td align="left" valign="top"><p class="table">01 : prepare trust root</p>
<p class="table">                    80 : confirm trust root</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (prepare trust root)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root slot (0 to 2)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root identity length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root identity (max 20 bytes)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Private key value</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (confirm trust root)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (prepare trust root)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (confirm trust root)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Self signed certificate for this identity and trust root</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and is protected by the user PIN</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_create_certificate_bip_70">21.2. CREATE CERTIFICATE BIP 70</h3>
<div class="paragraph"><p>This command is used to create a new BIP 70 certificate associating an identity to a BIP 32 key path for the current seed and signed by the given Trusted Root. All children of this path can be certified by this certificate.</p></div>
<div class="paragraph"><p>The dongle returns a private part, wrapped for this dongle, containing the certificate private key, the BIP 32 path and the checksum of the public key at this root path, a certificate signed by the given Trust Root, and a checksum of the certificate that can be passed to the client through a second channel for validation.</p></div>
<div class="sect3">
<h4 id="_coding_17">21.2.1. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
<td align="left" valign="top"><p class="table">00 : generate the certificate</p>
<p class="table">                    80 : retrieve the second part of the certificate</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (first part)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root slot (0 to 2)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 9)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Subject Common Name length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Subject Common Name (max 20 bytes)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Validity start as UTC time</p></td>
<td align="left" valign="top"><p class="table">13</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Validity end as UTC time</p></td>
<td align="left" valign="top"><p class="table">13</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (second part)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (first part)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate private part length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate private part blob</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate public part checksum length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate public part checksum</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DER encoded certificate (first part)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (second part)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">DER encoded certificate (second part)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and is protected by the user PIN</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_create_payment_request_bip_70">21.3. CREATE PAYMENT REQUEST BIP 70</h3>
<div class="paragraph"><p>This command is used to create a new signed PaymentRequest with the provided certificate, validating that the address belongs to the user by checking that the provided BIP 32 derivation path is a child of the BIP 32 derivation path associated to the certificate.</p></div>
<div class="paragraph"><p>The PaymentRequest is prepared by the host and passed to the dongle for validation and signature. Elements serialized as Protocol Buffers wire types other than 2 shall be provided in a single APDU. The tag and length of elements serialized as Protocol Buffer wire type 2 shall be provided in a single APDU.</p></div>
<div class="paragraph"><p>The following elements of the PaymentRequest are validated by the dongle :</p></div>
<div class="ulist"><ul>
<li>
<p>
PaymentRequest.payment_details_version is set to 1
</p>
</li>
<li>
<p>
PaymentRequest.pki_type is set to x509+sha256
</p>
</li>
<li>
<p>
PaymentDetails.outputs has a single element
</p>
</li>
<li>
<p>
Output.script contains a simple transfer to the given derived address
</p>
</li>
</ul></div>
<div class="paragraph"><p>After validating the PaymentRequest, the dongle returns its signature.</p></div>
<div class="sect3">
<h4 id="_coding_18">21.3.1. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">34</p></td>
<td align="left" valign="top"><p class="table">00 : initialization</p>
<p class="table">80 : PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">00 : more PaymentRequest chunks expected</p>
<p class="table">80 : last PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (initialization)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate private part length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate private part</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (next payment request chunk)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Serialized PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (initialization)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output script length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output script</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (last PaymentRequest chunk)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">PaymentRequest signature</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (other)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and is protected by the user PIN</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_process_certificate_bip_70">21.4. PROCESS CERTIFICATE BIP 70</h3>
<div class="paragraph"><p>This command is used to approve the future use of an external BIP 70 Certificate by a dongle.</p></div>
<div class="paragraph"><p>After submitting the request, the certificate checksum is typed by the second factor. If validated and confirmed by the user, the encoded certificate valid for this dongle is returned.</p></div>
<div class="sect3">
<h4 id="_coding_19">21.4.1. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">36</p></td>
<td align="left" valign="top"><p class="table">00 : prepare certificate</p>
<p class="table">                    80 : confirm certificate</p></td>
<td align="left" valign="top"><p class="table">00 : when preparing, first certificate block</p>
<p class="table">                    80 : when preparing, next certificate block</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (prepare certificate, first block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root slot (0 to 2)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP 70 Certificate part</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (prepare certificate, next block)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP 70 Certificate part</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (confirm certificate)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation code</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (prepare certificate)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (confirm certificate)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded BIP 70 Certificate for this dongle</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and is protected by the user PIN</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_parse_payment_request_bip_70">21.5. PARSE PAYMENT REQUEST BIP 70</h3>
<div class="paragraph"><p>This command is used to approve the future use of an external BIP 70 Payment Request by a dongle.</p></div>
<div class="paragraph"><p>The serialzied PaymentRequest is passed to the dongle for validation. Elements serialized as Protocol Buffers wire types other than 2 shall be provided in a single APDU. The tag and length of elements serialized as Protocol Buffer wire type 2 shall be provided in a single APDU.</p></div>
<div class="paragraph"><p>If the PaymentRequest is successfully validated, an encoded PaymentRequest valid for this dongle is returned</p></div>
<div class="sect3">
<h4 id="_coding_20">21.5.1. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">38</p></td>
<td align="left" valign="top"><p class="table">00 : first PaymentRequest chunk</p>
<p class="table">80 : next PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">00 : more PaymentRequest chunks expected</p>
<p class="table">80 : last PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (first payment request chunk)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded certificate length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded certificate</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (next payment request chunk)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Serialized PaymentRequest chunk</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (last PaymentRequest chunk)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded PaymentRequest for this dongle</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (other)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet and is protected by the user PIN</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_untrusted_hash_transaction_input_finalize_bip_70">21.6. UNTRUSTED HASH TRANSACTION INPUT FINALIZE BIP 70</h3>
<div class="sect3">
<h4 id="_description_17">21.6.1. Description</h4>
<div class="paragraph"><p>This command is used to compose an opaque SHA-256 hash for the transaction outputs</p></div>
<div class="paragraph"><p>This command is rejected if all inputs advertised at the beginning of the transaction have not been processed first.</p></div>
<div class="paragraph"><p>The output address and amount are provided by a previously encoded PaymentRequest</p></div>
</div>
<div class="sect3">
<h4 id="_coding_21">21.6.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">3A</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of encoded PaymentRequest</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded PaymentRequest</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Fees (big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 10)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index for the internal change address (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index for the internal change address (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in standard wallet, relaxed wallet modes.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_mode_apdus">22. Server mode APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_get_transaction_limit">22.1. GET TRANSACTION LIMIT</h3>
<div class="sect3">
<h4 id="_description_18">22.1.1. Description</h4>
<div class="paragraph"><p>This command returns the current cumulative amount limit and the number of transactions remaining</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">This function is not supported in this version</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_coding_22">22.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">A0</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">0C</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Remaining cumulative amount (big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Remaining number of transactions</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in server operation modes.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_set_transaction_limit">22.2. SET TRANSACTION LIMIT</h3>
<div class="sect3">
<h4 id="_description_19">22.2.1. Description</h4>
<div class="paragraph"><p>This command sets the current cumulative amount limit and the number of transactions remaining.</p></div>
<div class="paragraph"><p>This command is protected by the HOTP server key. If the OTP is correct, the command is executed, the transaction limit is updated immediately and the OTP sequence counter is increased.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">This function is not supported in this version</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_coding_23">22.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">A2</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">8 digits HOTP code</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Cumulative amount (big endian)</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of transactions after power up</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in server operation modes.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_developer_mode_apdus">23. Developer mode APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_import_private_key">23.1. IMPORT PRIVATE KEY</h3>
<div class="sect3">
<h4 id="_description_20">23.1.1. Description</h4>
<div class="paragraph"><p>This command imports a regular private key, a BIP32 private key or a BIP32 seed and returns an encrypted version of the private key that this dongle can use for future operations.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_24">23.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">B0</p></td>
<td align="left" valign="top"><p class="table">Import method</p>
<p class="table">                    0x01 : Base58 encoded private key or BIP32 private key</p>
<p class="table">                    0x02 : BIP32 seed</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Base58 private key or seed</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in developer operation mode.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_public_key">23.2. GET PUBLIC KEY</h3>
<div class="sect3">
<h4 id="_description_21">23.2.1. Description</h4>
<div class="paragraph"><p>This command returns the public key or the extended public key for an encoded private key</p></div>
</div>
<div class="sect3">
<h4 id="_coding_25">23.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">B2</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (non HD key)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flag : 0x01</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (HD key)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flag : 0x02</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Chain code</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Depth</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Parent fingerprint</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Child number (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in developer operation mode, and is protected by the user PIN.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_derive_bip32_key">23.3. DERIVE BIP32 KEY</h3>
<div class="sect3">
<h4 id="_description_22">23.3.1. Description</h4>
<div class="paragraph"><p>This command derives a BIP32 key to return a child key.</p></div>
<div class="paragraph"><p>This command returns an error if operating on a non BIP32 key</p></div>
<div class="paragraph"><p>Both hardened and non hardened derivation modes are supported.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_26">23.3.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">B4</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Child index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in developer operation mode.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ecdsa_sign_verify_immediate">23.4. ECDSA SIGN/VERIFY IMMEDIATE</h3>
<div class="sect3">
<h4 id="_description_23">23.4.1. Description</h4>
<div class="paragraph"><p>This command is used to sign a given hash using an encoded private key or verify a given signature using a public key</p></div>
</div>
<div class="sect3">
<h4 id="_coding_27">23.4.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">B6</p></td>
<td align="left" valign="top"><p class="table">00 : sign</p>
<p class="table">                     80 : verify</p></td>
<td align="left" valign="top"><p class="table">00 : sign with random K</p>
<p class="table">                                            80 : sign with deterministic K</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (sign mode)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of encoded private key</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encoded private key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of hash to sign (up to 32 bytes)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Hash to sign</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (verify mode)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of uncompressed public key</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Uncompressed Public key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Length of hash to verify (up to 32 bytes)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Hash to verify </p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signature</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (sign mode)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signed hash, as ASN-1 encoded R &amp; S components. Mask first byte with 0xFE</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (verify mode)</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup in developer operation mode, and is protected by the user PIN</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_and_utility_apdus">24. Test and utility APDUs</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_get_random">24.1. GET RANDOM</h3>
<div class="sect3">
<h4 id="_description_24">24.1.1. Description</h4>
<div class="paragraph"><p>This command returns random bytes from the dongle hardware random number generator</p></div>
</div>
<div class="sect3">
<h4 id="_coding_28">24.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">C0</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Random bytes</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_device_attestation">24.2. GET DEVICE ATTESTATION</h3>
<div class="sect3">
<h4 id="_description_25">24.2.1. Description</h4>
<div class="paragraph"><p>This command returns a signature of the 6 bytes current firmware version concatenated to the given blob by the attestation key.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_29">24.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">C2</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">08</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Blob to sign</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Attestation key batch ID</p></td>
<td align="left" valign="top"><p class="table">04</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Attestation key derivation index ID</p></td>
<td align="left" valign="top"><p class="table">04</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Supported operation modes bitflag</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Current operation mode</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware major version</p></td>
<td align="left" valign="top"><p class="table">02</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware minor version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware patch version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Loader ID major version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Loader ID minor version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signature of 8 previous bytes + blob</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_firmware_version">24.3. GET FIRMWARE VERSION</h3>
<div class="sect3">
<h4 id="_description_26">24.3.1. Description</h4>
<div class="paragraph"><p>This command returns the firmware version of the dongle</p></div>
</div>
<div class="sect3">
<h4 id="_coding_30">24.3.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">C4</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">07</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Internal public keys compression flag</p>
<p class="table">                    0x00 : keys are not compressed</p>
<p class="table">                    0x01 : keys are compressed</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware major version</p></td>
<td align="left" valign="top"><p class="table">02</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware minor version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware patch version (0xFF since Ledger Wallet firmware)</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Loader ID major version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Loader ID minor version</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_compose_m_of_n_address">24.4. COMPOSE M OF N ADDRESS</h3>
<div class="sect3">
<h4 id="_description_27">24.4.1. Description</h4>
<div class="paragraph"><p>This command is used to create and check on the fly a P2SH payment address to an M of N transaction, according to BIP 16 and BIP 11.</p></div>
<div class="paragraph"><p>Each public key address is prompted to the user and validated by entering a PIN code as per the second factor mechanism.</p></div>
<div class="paragraph"><p>After all public key addresses have been provided, the final address is typed to the user using the second factor mechanism.</p></div>
<div class="paragraph"><p>Public keys can be provided in compressed or uncompressed format.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">This function is not supported in this version</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_coding_31">24.4.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">C6</p></td>
<td align="left" valign="top"><p class="table">00 : start composing a new address</p>
<p class="table">                    80 : continue composing an address with a new public key</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (for a new address)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">M (number of signatures to provide to redeem the transaction, must be smaller than or equal to N)</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">N (total number of public keys provided, must be smaller than or equal to 3)</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Public key</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data (to keep on submitting a new key)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Authorization length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Authorization</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Optional Public key, ignored for the last one</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">User validation flag</p>
<p class="table">      0x01 : user validation requested</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is always available following dongle setup (but is not usable in server mode)</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_point_of_sale_seed">24.5. GET POINT OF SALE SEED</h3>
<div class="sect3">
<h4 id="_description_28">24.5.1. Description</h4>
<div class="paragraph"><p>This command is used to retrieve the seed backup if the dongle was set up in Point Of Sale mode.</p></div>
<div class="paragraph"><p>The seed backup is split into 2 components :</p></div>
<div class="ulist"><ul>
<li>
<p>
A seed 3DES encryption key, randomly generated by the dongle
</p>
</li>
<li>
<p>
The encrypted seed
</p>
</li>
</ul></div>
<div class="paragraph"><p>It is recommended to retrieve each seed component on a different host.</p></div>
<div class="paragraph"><p>The dongle must be powercycled after processing this command.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_32">24.5.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">E0</p></td>
<td align="left" valign="top"><p class="table">CA</p></td>
<td align="left" valign="top"><p class="table">01 : request seed encryption key</p>
<p class="table">                    02 : request encrypted seed</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data (for seed encryption key)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Seed encryption key</p></td>
<td align="left" valign="top"><p class="table">16</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data (for encrypted seed)</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encrypted seed</p></td>
<td align="left" valign="top"><p class="table">64</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is available after setup in Point Of Sale mode and is disabled after the encrypted seed is retrieved once</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vendor_management_apdus">25. Vendor management APDUs</h2>
<div class="sectionbody">
<div class="paragraph"><p>These APDUs are used for factory setup and firmware updates.</p></div>
<div class="sect2">
<h3 id="_factory_initialize_keys">25.1. FACTORY INITIALIZE KEYS</h3>
<div class="sect3">
<h4 id="_description_29">25.1.1. Description</h4>
<div class="paragraph"><p>This command is used to derive the factory update, attestation storage, BIP 70 initial Trust Root storage and optionally keycard keys from the shared rom key before issuance.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_33">25.1.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">20</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">38 or 48</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware update ID</p></td>
<td align="left" valign="top"><p class="table">08</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Attestation storage key diversifier</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP 70 Trust Root key diversifier</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware update key diversifier</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Keycard key diversifier</p></td>
<td align="left" valign="top"><p class="table">10</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available pre issuance</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_factory_initialize_attestation">25.2. FACTORY INITIALIZE ATTESTATION</h3>
<div class="sect3">
<h4 id="_description_30">25.2.1. Description</h4>
<div class="paragraph"><p>This command sets up the attestation private key used to authenticate the device.</p></div>
<div class="paragraph"><p>The dongle switches to post-issuance mode once this APDU is received and handled successfully.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_34">25.2.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">22</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">2B</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Attestation key batch ID</p></td>
<td align="left" valign="top"><p class="table">04</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Attestation key derivation index ID</p></td>
<td align="left" valign="top"><p class="table">04</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Wrapped attestation private key</p></td>
<td align="left" valign="top"><p class="table">35</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available pre issuance</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_get_firmware_update_id">25.3. GET FIRMWARE UPDATE ID</h3>
<div class="sect3">
<h4 id="_description_31">25.3.1. Description</h4>
<div class="paragraph"><p>This command returns the firmware update ID of this dongle.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_35">25.3.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">24</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">08</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware update ID</p></td>
<td align="left" valign="top"><p class="table">08</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available before the dongle is set up (either when received or following a dongle reset)</p></div>
</div>
</div>
<div class="sect2">
<h3 id="Keycard">25.4. FACTORY INITIALIZE KEYCARD SEED</h3>
<div class="sect3">
<h4 id="_description_32">25.4.1. Description</h4>
<div class="paragraph"><p>This command is used to replace the keyboard second factor by a printed keycard for regular (non relaxed) transactions</p></div>
<div class="paragraph"><p>The keycard associates each ASCII character between 0x30 and 0x7a (included) to an hexadecimal digit, obtained by encrypting 00..50 by the 3DES-2 keycard seed key using CBC encryption, and considering each digit as an exclusive OR of both nibbles of each element</p></div>
<div class="paragraph"><p>When using the keycard second factor, the user needs to provide as authentication code random A characters of the destination address (up to 10)</p></div>
</div>
<div class="sect3">
<h4 id="_coding_36">25.4.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">26</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">1B</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Wrapped number of random address characters A to provide (1 byte) + keycard seed (16 bytes)</p></td>
<td align="left" valign="top"><p class="table">1B</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available pre issuance</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_factory_initialize_bip_70_trust_root">25.5. FACTORY INITIALIZE BIP 70 TRUST ROOT</h3>
<div class="sect3">
<h4 id="_description_33">25.5.1. Description</h4>
<div class="paragraph"><p>This command sets up an initial BIP 70 Trust Root</p></div>
</div>
<div class="sect3">
<h4 id="_coding_37">25.5.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">28</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Wrapped (slot index</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root identity length</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Trust root identity (max 20 bytes)</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">BIP 70 Trust Root private key)</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available pre issuance</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_firmware_update">25.6. FIRMWARE UPDATE</h3>
<div class="sect3">
<h4 id="_description_34">25.6.1. Description</h4>
<div class="paragraph"><p>This command is used to update the dongle firmware.</p></div>
<div class="paragraph"><p>The dongle must not been set up to issue this command - if the dongle is set up, first wipe the user data by issuing the wrong user PIN 3 times.</p></div>
</div>
<div class="sect3">
<h4 id="_coding_38">25.6.2. Coding</h4>
<div class="paragraph"><p><em>Command</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<col width="16%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>CLA</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>INS</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P1</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>P2</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Lc</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Le</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">D0</p></td>
<td align="left" valign="top"><p class="table">42</p></td>
<td align="left" valign="top"><p class="table">03 : start bootloader</p>
<p class="table">                     06 : load bootloader</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
<td align="left" valign="top"><p class="table">00</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Input data</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Firmware blob</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><em>Output data</em></p></div>
<div class="paragraph"><p>None</p></div>
<div class="paragraph"><p><em>Availability</em></p></div>
<div class="paragraph"><p>This function is only available before the dongle is set up (either when received or following a dongle reset)</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_status_words">26. Status Words</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following standard Status Words are returned for all APDUs - some specific Status Words can be used for specific commands and are mentioned in the command description.</p></div>
<div class="paragraph"><p><em>Status Words</em></p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>SW</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6700</p></td>
<td align="left" valign="top"><p class="table">Incorrect length</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6982</p></td>
<td align="left" valign="top"><p class="table">Security status not satisfied (Bitcoin dongle is locked or invalid access rights)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6A80</p></td>
<td align="left" valign="top"><p class="table">Invalid data</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6A82</p></td>
<td align="left" valign="top"><p class="table">File not found</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6B00</p></td>
<td align="left" valign="top"><p class="table">Incorrect parameter P1 or P2</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">6Fxx</p></td>
<td align="left" valign="top"><p class="table">Technical problem (Internal error, please report)</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">9000</p></td>
<td align="left" valign="top"><p class="table">Normal ending of the command</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_structures">27. Data structures</h2>
<div class="sectionbody">
<div class="paragraph"><p>The format of the data structures is provided for interoperability and validation purposes. A typical user will not need to manipulate them directly.</p></div>
<div class="sect2">
<h3 id="_encoded_private_key_in_developer_mode">27.1. Encoded private key in developer mode</h3>
<div class="paragraph"><p>An encoded private key is stored internally as follow. The private key component (S) and optional chain are triple DES encrypted by the developer mode wrapping key in CBC mode with a null IV (as S alone or S concatenated to the chain code)</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Magic version (<strong>01</strong>)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Private key type</p>
<p class="table">    0x01 : standard private key</p>
<p class="table">    0x02 : BIP32 private key</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Version</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Private key component (S)</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">If BIP32, chain code</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">If BIP32, depth</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">If BIP32, parent fingerprint</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">If BIP32, child number (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_encoded_trusted_input">27.2. Encoded trusted input</h3>
<div class="paragraph"><p>An encoded trusted input is stored internally as follow. The signature is the last block of a Triple DES CBC encryption of the previous data by the trusted input encryption key.</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Magic version (<strong>32</strong>)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flags</p>
<p class="table">    RFU</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Nonce</p></td>
<td align="left" valign="top"><p class="table">2</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Associated transaction hash</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Index in associated transaction</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Associated amount</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signature</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_encoded_private_part_of_a_bip_70_personal_certificate">27.3. Encoded private part of a BIP 70 Personal Certificate</h3>
<div class="paragraph"><p>An encoded private part of a BIP 70 Personal Certificate is stored internally as follow. The private key component is triple DES encrypted by the BIP 70 encryption key in CBC mode with a null IV. The signature is the last block of a Triple DES CBC encryption of the previous data by the BIP 70 signature key.</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Magic version (<strong>03</strong>)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flags</p>
<p class="table">    RFU</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Nonce</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Encrypted certificate private key</p></td>
<td align="left" valign="top"><p class="table">32</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Number of BIP 32 derivations to perform (max 9)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">First derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">&#8230;</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Last derivation index (big endian)</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Associated public key checksum</p></td>
<td align="left" valign="top"><p class="table">4</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signature</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_encoded_bip_70_personal_certificate_for_dongle_consumption">27.4. Encoded BIP 70 Personal Certificate for dongle consumption</h3>
<div class="paragraph"><p>An encoded BIP 70 Personal Certificate for dongle consumption is stored internally as follow. The signature is the last block of a Triple DES CBC encryption of the previous data by the BIP 70 signature key.</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Magic version (<strong>04</strong>)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flags</p>
<p class="table">    RFU</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Nonce</p></td>
<td align="left" valign="top"><p class="table">5</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Certificate public key</p></td>
<td align="left" valign="top"><p class="table">65</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Signature</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_encoded_bip_70_paymentrequest_for_dongle_consumption">27.5. Encoded BIP 70 PaymentRequest for dongle consumption</h3>
<div class="paragraph"><p>An encoded BIP 70 PaymentRequest for dongle consumption is stored internally as follow. The signature is the last block of a Triple DES CBC encryption of the previous data by the BIP 70 signature key.</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Magic version (<strong>05</strong>)</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Flags</p>
<p class="table">    RFU</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Nonce</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Amount</p></td>
<td align="left" valign="top"><p class="table">8</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output script length</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Output script</p></td>
<td align="left" valign="top"><p class="table">var</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_specific_data_transport_for_firmware_update_or_private_key_attestation_storage">27.6. Specific data transport for firmware update or private key attestation storage</h3>
<div class="paragraph"><p>Data sent for firmware update or private key attestation storage is formatted as follows, encrypted by either the diversified firmware update key or the diversified attestation storage key</p></div>
<div class="tableblock">
<table rules="all"
width="80%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table"><strong>Description</strong></p></td>
<td align="left" valign="top"><p class="table"><strong>Length</strong></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Data size without padding</p></td>
<td align="left" valign="top"><p class="table">01</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">3DES-CBC encrypted data with a null IV</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Padding</p></td>
<td align="left" valign="top"><p class="table">variable</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">CRC-16 of the cleartext data block</p></td>
<td align="left" valign="top"><p class="table">02</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The target key is disabled after 10 invalid CRC-16 have been received in sequence.</p></div>
<div class="paragraph"><p>After each invalid CRC-16, the dongle has to be power cycled before accepting another command.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_attestation_keys">28. Attestation keys</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following Attestation keys are used</p></div>
<div class="ulist"><ul>
<li>
<p>
Batch ID 01, Derivation Index ID 01 (pre 1.4.11) : 04223314cdffec8740150afe46db3575fae840362b137316c0d222a071607d61b2fd40abb2652a7fea20e3bb3e64dc6d495d59823d143c53c4fe4059c5ff16e406
</p>
</li>
<li>
<p>
Batch ID 02, Derivation Index ID 01 (post 1.4.11) : 04c370d4013107a98dfef01d6db5bb3419deb9299535f0be47f05939a78b314a3c29b51fcaa9b3d46fa382c995456af50cd57fb017c0ce05e4a31864a79b8fbfd6
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2015-01-09 06:15:48 CET
</div>
</div>
</body>
</html>
